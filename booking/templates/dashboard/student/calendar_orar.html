{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<style>
    .interval-container { height: 34px; margin-bottom: 4px; min-width: 150px; width: 100%; }
    .table td { padding: 5px; vertical-align: middle; width: calc(100% / 8); white-space: nowrap; }
    .table th:first-child { width: 12%; }
    .table th:not(:first-child), .table td:not(:first-child) { width: 12.5%; }
    .table-responsive { overflow-x: auto; padding-right: 20px; margin-right: -10px; }
    .table th:first-child { min-width: 100px; width: 100px; }

    .time-slot { font-size: 0.9em; padding: 5px 8px; height: 100%; width: 100%;
                 display: flex; align-items: center; justify-content: center;
                 white-space: nowrap; }

    .btn-interval {
        width: 100%; height: 100%; min-width: 150px;
        display: flex; align-items: center; justify-content: center;
        border: 1px solid #28a745; color: #28a745;
        background-color: transparent; border-radius: 4px;
    }
    .btn-interval:hover { background-color: #28a745; color: white; }

    .rezervare {
        height: 100%; width: 100%; padding: 5px 8px;
        border-radius: 4px; display: flex; align-items: center;
        white-space: nowrap;
    }

    .bg-danger{ background-color:#dc3545!important;color:#fff!important; }
    .bg-secondary{ background-color:#6c757d!important;color:#fff!important; }
    .bg-primary{ background-color:#0d6efd!important;color:#fff!important; }
    .bg-brown{ background-color:#D2B48C!important;color:#fff!important; }
    .bg-warning{ background-color:#ffc107!important;color:#000!important; }
    .bg-own{ background-color:#b3e5fc!important;color:#01579b!important; }

    .btn-icon{ background:none;border:none;color:white; width:20px;height:20px; }
    .btn-icon i { font-size: .8rem; }

    /* sticky */
    .calendar-grid thead th { position: sticky; top: 0; background:white; z-index: 3; }
    .calendar-grid th.bg-light { position: sticky; left:0; background:white; z-index:2; }

    /* zebra */
    .calendar-grid tbody td:nth-child(odd) { background:#fbfdff; }
</style>

<div class="container mt-4 fade-in">

    <div class="py-3 px-4 mb-4 rounded shadow bg-white">
        <h2 class="text-center fw-bold" style="font-size:1.8rem;">
            Rezervari Spalatorie – {{ nume_camin }}
            ({{ start_saptamana|date:"d M" }} – {{ end_saptamana|date:"d M" }})
        </h2>

        <div class="d-flex justify-content-between">
            <a href="?saptamana={{ saptamana_precedenta }}" class="btn btn-light">← Săptămâna trecută</a>
            <a href="?saptamana={{ saptamana_urmatoare }}" class="btn btn-light">Săptămâna viitoare →</a>
        </div>
    </div>

    {% if not are_telefon %}
    <div class="alert alert-danger shadow-sm d-flex justify-content-between align-items-center">
        <span>Adaugă număr de telefon pentru notificări WhatsApp!</span>
        <a href="{% url 'dashboard_student' %}" class="btn btn-light btn-sm">Adaugă număr</a>
    </div>
    {% endif %}

    <div class="table-responsive">
        <table class="table table-bordered text-center align-middle calendar-grid">
            <thead>
                <tr>
                    <th>Mașină</th>
                    {% for zi in zile_saptamana %}
                        <th>{{ zi|date:"D, d M" }}</th>
                    {% endfor %}
                </tr>
            </thead>

            <tbody>

            {% for masina in masini %}
                <tr>
                    <th class="bg-light">{{ masina.nume }}</th>

                    {% for zi in zile_saptamana %}
                    <td>

                    {% for interval in intervale_ore %}
                        {% with ora_start=interval.0 ora_sfarsit=interval.1 %}
                        {% with rezervare=rezervari_dict|get_item:masina.id|get_item:zi|get_item:ora_start %}

                        {# ===================== SLOT CU REZERVARE ===================== #}
                        {% if rezervare %}

                            <div class="interval-container">
                                <div class="rezervare
                                    {% if zi < today %}
                                        bg-warning
                                    {% elif zi == today and ora_sfarsit <= now_hour %}
                                        bg-warning
                                    {% elif rezervare.utilizator == request.user %}
                                        bg-own
                                    {% else %}
                                        {% if rezervare.nivel_prioritate == 1 %}bg-danger{% endif %}
                                        {% if rezervare.nivel_prioritate == 2 %}bg-secondary{% endif %}
                                        {% if rezervare.nivel_prioritate == 3 %}bg-primary{% endif %}
                                        {% if rezervare.nivel_prioritate == 4 %}bg-brown{% endif %}
                                    {% endif %}"
                                    data-nume="{{ rezervare.utilizator.last_name }} {{ rezervare.utilizator.first_name }}"
                                    data-email="{{ rezervare.utilizator.email }}"
                                    data-camera="{{ rezervare.utilizator.profilstudent.numar_camera|default:'-' }}"
                                    data-telefon="{{ rezervare.utilizator.profilstudent.telefon|default:'-' }}"
                                    style="cursor:pointer;">

                                    <div class="d-flex w-100">
                                        <span class="flex-grow-1">{{ ora_start }}:00 - {{ ora_sfarsit }}:00</span>

                                        {# buton avertisment – rezervări trecute #}
                                        {% if este_admin_camin and (zi < today or zi == today and ora_sfarsit <= now_hour) %}
                                            <button type="button" class="btn-icon text-warning"
                                                data-bs-toggle="modal" data-bs-target="#confirmModal"
                                                data-rezervare-id="{{ rezervare.id }}"
                                                data-nume="{{ rezervare.utilizator.get_full_name }}"
                                                data-data="{{ rezervare.data_rezervare|date:'d M Y' }}"
                                                data-interval="{{ rezervare.ora_start|time:'H:i' }} - {{ rezervare.ora_end|time:'H:i' }}">
                                                <i class="fas fa-exclamation-triangle"></i>
                                            </button>
                                        {% endif %}

                                        {# buton preluare rezervare – doar viitor #}
                                        {% if rezervare.nivel_prioritate != 1 %}
                                            {% if zi > today or zi == today and ora_sfarsit > now_hour %}
                                                {% if este_admin_camin or este_student %}
                                                    <form method="post" action="{% url 'creeaza_rezervare' %}">
                                                        {% csrf_token %}
                                                        <input type="hidden" name="masina_id" value="{{ masina.id }}">
                                                        <input type="hidden" name="data" value="{{ zi|date:'Y-m-d' }}">
                                                        <input type="hidden" name="ora_start" value="{{ ora_start }}:00">
                                                        <input type="hidden" name="ora_end" value="{{ ora_sfarsit }}:00">
                                                        <input type="hidden" name="saptamana" value="{{ saptamana_index }}">
                                                        <button class="btn-icon"><i class="fas fa-exchange-alt"></i></button>
                                                    </form>
                                                {% endif %}
                                            {% endif %}
                                        {% endif %}

                                    </div>
                                </div>
                            </div>

                        {# ===================== SLOT FĂRĂ REZERVARE ===================== #}
                        {% else %}

                            {% if zi < today %}
                                <div class="interval-container">
                                    <div class="time-slot text-muted">{{ ora_start }}:00 - {{ ora_sfarsit }}:00</div>
                                </div>

                            {% elif zi == today and ora_sfarsit <= now_hour %}
                                <div class="interval-container">
                                    <div class="time-slot text-muted">{{ ora_start }}:00 - {{ ora_sfarsit }}:00</div>
                                </div>

                            {% else %}
                                <div class="interval-container">
                                    <form method="post" action="{% url 'creeaza_rezervare' %}" class="h-100">
                                        {% csrf_token %}
                                        <input type="hidden" name="masina_id" value="{{ masina.id }}">
                                        <input type="hidden" name="data" value="{{ zi|date:'Y-m-d' }}">
                                        <input type="hidden" name="ora_start" value="{{ ora_start }}:00">
                                        <input type="hidden" name="ora_end" value="{{ ora_sfarsit }}:00">
                                        <input type="hidden" name="saptamana" value="{{ saptamana_index }}">
                                        <button type="submit" class="btn-interval">{{ ora_start }}:00 - {{ ora_sfarsit }}:00</button>
                                    </form>
                                </div>
                            {% endif %}

                        {% endif %}
                        {% endwith %}
                        {% endwith %}
                    {% endfor %}

                    </td>
                    {% endfor %}
                </tr>
            {% endfor %}

            </tbody>
        </table>
    </div>
</div>

{# ==========================================
   MODAL AVERTISMENT
   ========================================== #}
<div class="modal fade" id="confirmModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="{% url 'adauga_avertisment_din_calendar' %}">
        {% csrf_token %}
        <input type="hidden" name="rezervare_id" id="rezervareIdInput">
        <div class="modal-header">
          <h5 class="modal-title">Confirmare Avertisment</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          Trimiți avertisment pentru <strong id="studentName"></strong>  
          ( <span id="rezervareInfo"></span> )?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Renunță</button>
          <button type="submit" class="btn btn-warning">Trimite</button>
        </div>
      </form>
    </div>
  </div>
</div>

{# ==========================================
   OFFCANVAS DETALII STUDENT
   ========================================== #}
<div class="offcanvas offcanvas-end" id="detaliiStudent">
  <div class="offcanvas-header">
    <h5>Detalii Student</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <p><strong>Nume:</strong> <span id="studentNume"></span></p>
    <p><strong>Email:</strong> <span id="studentEmail"></span></p>
    <p><strong>Telefon:</strong> <span id="studentTelefon"></span></p>
    <p><strong>Cameră:</strong> <span id="studentCamera"></span></p>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {

  // tooltips
  document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
      new bootstrap.Tooltip(el);
  });

  // modal avertisment
  const modal = document.getElementById('confirmModal');
  if (modal) {
    modal.addEventListener('show.bs.modal', e => {
        const btn = e.relatedTarget;
        document.getElementById('rezervareIdInput').value = btn.dataset.rezervareId;
        document.getElementById('studentName').textContent = btn.dataset.nume;
        document.getElementById('rezervareInfo').textContent =
          btn.dataset.data + " " + btn.dataset.interval;
    });
  }

  // offcanvas detalii student
  document.querySelectorAll(".rezervare").forEach(el => {
    el.addEventListener("click", e => {
        if (e.target.closest("button")) return;
        document.getElementById("studentNume").textContent = el.dataset.nume;
        document.getElementById("studentEmail").textContent = el.dataset.email;
        document.getElementById("studentTelefon").textContent = el.dataset.telefon;
        document.getElementById("studentCamera").textContent = el.dataset.camera;
        new bootstrap.Offcanvas(document.getElementById("detaliiStudent")).show();
    });
  });

});
</script>

{% endblock %}

