{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<style>
    .interval-container { height: 34px; margin-bottom: 4px; min-width: 150px; width: 100%; }
    .table td { padding: 5px; vertical-align: middle; width: calc(100% / 8); white-space: nowrap; }
    .table th:first-child { width: 12%; }
    .table th:not(:first-child), .table td:not(:first-child) { width: 12.5%; }
    .table-responsive { overflow-x: auto; padding-right: 20px; margin-right: -10px; }
    .time-slot { font-size: 0.9em; padding: 5px 8px; height: 100%; display: flex; align-items: center; justify-content: center; }
    .btn-interval { width: 100%; border: 1px solid #28a745; color: #28a745; border-radius: 4px; transition: all 0.2s ease; }
    .btn-interval:hover { background-color: #28a745; color: white; }
    .rezervare { height: 100%; width: 100%; padding: 5px 8px; border-radius: 4px; display: flex; align-items: center; transition: all 0.3s ease; }
    .bg-danger { background-color: #dc3545 !important; color: white !important; border: 1px solid #bd2130; }
    .bg-secondary { background-color: #6c757d !important; color: white !important; border: 1px solid #545b62; }
    .bg-primary { background-color: #0d6efd !important; color: white !important; border: 1px solid #0257d5; }
    .bg-brown { background-color: #d2b48c !important; color: white !important; border: 1px solid #bc9f7b; }
    .bg-warning { background-color: #ffc107 !important; color: black !important; border: 1px solid #d39e00; }
    .bg-own { background-color: #b3e5fc !important; border: 1px solid #0288d1 !important; color: #01579b !important; }
</style>

<div class="container mt-4 fade-in">
    <div class="py-3 px-4 mb-4 rounded shadow text-black" style="background-color:white;">
        <h2 class="mb-3 text-center fw-bold">Rezervari Spalatorie â€“ {{ nume_camin|default:"CÄƒmin necunoscut" }} ({{ start_saptamana|date:"d M" }} â€“ {{ end_saptamana|date:"d M" }})</h2>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered text-center align-middle">
            <thead>
                <tr>
                    <th>MaÈ™inÄƒ</th>
                    {% for zi in zile_saptamana %}
                        <th>{{ zi|date:"D, d M" }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for masina in masini %}
                    <tr>
                        <th class="bg-light">{{ masina.nume }}</th>
                        {% for zi in zile_saptamana %}
                            <td>
                                {% for ora in intervale_ore %}
                                    {% with ora_sfarsit=ora|add:"2" %}
                                        {% with rezervare=rezervari_dict|get_item:masina.id|get_item:zi|get_item:ora %}
                                            {% if rezervare %}
                                                <div class="interval-container">
                                                    <div class="rezervare 
                                                        {% if zi < today %} bg-warning
                                                        {% elif rezervare.utilizator == request.user %} bg-own
                                                        {% elif rezervare.nivel_prioritate == 1 %} bg-danger
                                                        {% elif rezervare.nivel_prioritate == 2 %} bg-secondary
                                                        {% elif rezervare.nivel_prioritate == 3 %} bg-primary
                                                        {% elif rezervare.nivel_prioritate == 4 %} bg-brown
                                                        {% endif %}">
                                                        <span class="flex-grow-1">{{ ora }}:00 - {{ ora_sfarsit }}:00</span>
                                                    </div>
                                                </div>
                                            {% else %}
                                                {# ðŸ”¹ Slot liber sau trecut #}
                                                {% if zi > today and este_admin_camin or zi > today and este_student %}
                                                    <div class="interval-container">
                                                        <form method="post" action="{% url 'creeaza_rezervare' %}" class="h-100">
                                                            {% csrf_token %}
                                                            <input type="hidden" name="masina_id" value="{{ masina.id }}">
                                                            <input type="hidden" name="data" value="{{ zi|date:'Y-m-d' }}">
                                                            <input type="hidden" name="ora_start" value="{{ ora }}:00">
                                                            <input type="hidden" name="ora_end" value="{{ ora_sfarsit }}:00">
                                                            <input type="hidden" name="saptamana" value="{{ saptamana_index }}">
                                                            <button type="submit" class="btn-interval">{{ ora }}:00 - {{ ora_sfarsit }}:00</button>
                                                        </form>
                                                    </div>
                                                {% elif zi == today and ora|add:":00" > current_time|stringformat:"H:i:s" and este_admin_camin or zi == today and ora|add:":00" > current_time|stringformat:"H:i:s" and este_student %}
                                                    <div class="interval-container">
                                                        <form method="post" action="{% url 'creeaza_rezervare' %}" class="h-100">
                                                            {% csrf_token %}
                                                            <input type="hidden" name="masina_id" value="{{ masina.id }}">
                                                            <input type="hidden" name="data" value="{{ zi|date:'Y-m-d' }}">
                                                            <input type="hidden" name="ora_start" value="{{ ora }}:00">
                                                            <input type="hidden" name="ora_end" value="{{ ora_sfarsit }}:00">
                                                            <input type="hidden" name="saptamana" value="{{ saptamana_index }}">
                                                            <button type="submit" class="btn-interval">{{ ora }}:00 - {{ ora_sfarsit }}:00</button>
                                                        </form>
                                                    </div>
                                                {% elif zi == today and ora|add:":00" <= current_time|stringformat:"H:i:s" %}
                                                    <div class="interval-container">
                                                        <div class="time-slot bg-warning text-dark">{{ ora }}:00 - {{ ora_sfarsit }}:00</div>
                                                    </div>
                                                {% else %}
                                                    <div class="interval-container">
                                                        <div class="time-slot text-muted">{{ ora }}:00 - {{ ora_sfarsit }}:00</div>
                                                    </div>
                                                {% endif %}
                                            {% endif %}
                                        {% endwith %}
                                    {% endwith %}
                                {% endfor %}
                            </td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% endblock %}
