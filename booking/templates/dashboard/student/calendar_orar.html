{% extends 'base.html' %} {% load static %} {% load custom_filters %} {% block
content %}
<style>
  .interval-container {
    height: 34px;
    margin-bottom: 4px;
    min-width: 150px;
    width: 100%;
  }

  .table td {
    padding: 5px;
    vertical-align: middle;
    width: calc(100% / 8); /* 1 col pt ma»ôinƒÉ + 7 zile = 8 total */
    white-space: nowrap;
  }

  .table th:first-child {
    width: 12%; /* Ma»ôinƒÉ */
  }

  .table th:not(:first-child),
  .table td:not(:first-child) {
    width: 12.5%; /* Cele 7 zile √ÆmpƒÉr»õite egal */
  }

  .table-responsive {
    overflow-x: auto;
    padding-right: 20px; /* üëà adaugƒÉ spa»õiu pe dreapta */
    margin-right: -10px; /* micƒÉ corec»õie pentru aliniere */
  }

  .table th:first-child {
    min-width: 100px;
    width: 100px;
  }

  .table-responsive {
    overflow-x: auto;
  }

  .time-slot {
    font-size: 0.9em;
    padding: 5px 8px;
    height: 100%;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    text-decoration: none;
    white-space: nowrap;
  }

  .btn-interval {
    width: 100%;
    height: 100%;
    min-width: 150px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #28a745;
    color: #28a745;
    background-color: transparent;
    border-radius: 4px;
    transition: all 0.2s ease;
    white-space: nowrap;
  }

  .btn-interval:hover {
    background-color: #28a745;
    color: white;
  }

  .rezervare {
    height: 100%;
    width: 100%;
    padding: 5px 8px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    transition: all 0.3s ease;
    white-space: nowrap;
  }

  .bg-danger {
    background-color: #dc3545 !important;
    color: white !important;
    border: 1px solid #bd2130;
  }

  .bg-secondary {
    background-color: #6c757d !important;
    color: white !important;
    border: 1px solid #545b62;
  }

  .bg-primary {
    background-color: #0d6efd !important;
    color: white !important;
    border: 1px solid #0257d5;
  }

  .bg-brown {
    background-color: #d2b48c !important;
    color: white !important;
    border: 1px solid #bc9f7b;
  }

  .bg-warning {
    background-color: #ffc107 !important;
    color: black !important;
    border: 1px solid #d39e00;
  }

  .btn-icon {
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.8);
    padding: 0;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btn-icon:hover {
    color: white;
    transform: scale(1.1);
  }

  .btn-icon i {
    font-size: 0.8rem;
  }

  .container {
    max-width: 100%;
  }

  .shadow {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
  }

  .badge {
    width: 20px;
    height: 20px;
    padding: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  .legend-item {
    display: flex;
    align-items: center;
    margin: 0.5rem;
  }

  .legend-text {
    margin-left: 0.5rem;
    font-size: 0.875rem;
    color: #666;
  }

  .toast {
    opacity: 1 !important;
    background-color: white !important;
  }

  .toast .toast-body {
    color: black !important;
    font-weight: 500;
  }

  .tooltip {
    font-size: 0.8rem;
  }

  .bg-own {
    background-color: #b3e5fc !important; /* albastru pastel */
    border: 1px solid #0288d1 !important;
    color: #01579b !important;
  }
</style>

<div class="container mt-4 fade-in">
  <div
    class="py-3 px-4 mb-4 rounded shadow text-black"
    style="background-color: rgb(255, 255, 255)"
  >
    <h2 class="mb-3 text-center fw-bold" style="font-size: 1.8rem">
      Rezervari Spalatorie ‚Äì camin {{ nume_camin|default:"CƒÉmin necunoscut" }}
      ({{ start_saptamana|date:"d M" }} ‚Äì {{ end_saptamana|date:"d M" }})
    </h2>

    <div class="mb-4">
      <div class="d-flex justify-content-center flex-wrap">
        <div
          class="legend-item"
          data-bs-toggle="tooltip"
          title="Prima rezervare ‚Äì protejatƒÉ, nu poate fi preluatƒÉ"
        >
          <span class="badge bg-danger">‚ñ†</span
          ><span class="legend-text">Prima rezervare</span>
        </div>
        <div
          class="legend-item"
          data-bs-toggle="tooltip"
          title="A doua rezervare ‚Äì preluabilƒÉ"
        >
          <span class="badge bg-secondary">‚ñ†</span
          ><span class="legend-text">A doua rezervare</span>
        </div>
        <div
          class="legend-item"
          data-bs-toggle="tooltip"
          title="A treia rezervare ‚Äì preluabilƒÉ"
        >
          <span class="badge bg-primary">‚ñ†</span
          ><span class="legend-text">A treia rezervare</span>
        </div>
        <div
          class="legend-item"
          data-bs-toggle="tooltip"
          title="A patra rezervare ‚Äì preluabilƒÉ"
        >
          <span class="badge bg-brown">‚ñ†</span
          ><span class="legend-text">A patra rezervare</span>
        </div>
        <div
          class="legend-item"
          data-bs-toggle="tooltip"
          title="Rezervare trecutƒÉ (expiratƒÉ)"
        >
          <span class="badge bg-warning">‚ñ†</span
          ><span class="legend-text">Rezervare trecutƒÉ</span>
        </div>
        <div
          class="legend-item"
          data-bs-toggle="tooltip"
          title="Interval liber ‚Äì po»õi face o rezervare"
        >
          <span class="badge bg-success">‚ñ†</span
          ><span class="legend-text">Slot disponibil</span>
        </div>
        <div
          class="legend-item"
          data-bs-toggle="tooltip"
          title="RezervƒÉrile mele active"
        >
          <span class="badge bg-own">‚ñ†</span
          ><span class="legend-text">RezervƒÉrile mele</span>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-between">
      <a
        href="?saptamana={{ saptamana_precedenta }}"
        class="btn btn-light px-4 py-2 fw-semibold"
        >‚Üê SƒÉptƒÉm√¢na trecutƒÉ</a
      >
      <a
        href="?saptamana={{ saptamana_urmatoare }}"
        class="btn btn-light px-4 py-2 fw-semibold"
        >SƒÉptƒÉm√¢na viitoare ‚Üí</a
      >
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered text-center align-middle">
      <thead>
        <tr>
          <th>Ma»ôinƒÉ</th>
          {% for zi in zile_saptamana %}
          <th>{{ zi|date:"D, d M" }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for masina in masini %}
        <tr>
          <th class="bg-light">{{ masina.nume }}</th>
          {% for zi in zile_saptamana %}
          <td>
            {% for ora in intervale_ore %} {% with ora_sfarsit=ora|add:"2" %} {%
            with
            rezervare=rezervari_dict|get_item:masina.id|get_item:zi|get_item:ora
            %} {% if rezervare %}
            <div class="interval-container">
              <div
                class="rezervare {% if zi < today %} bg-warning {% elif rezervare.utilizator == request.user %} bg-own {% else %} {% if rezervare.nivel_prioritate == 1 %}bg-danger{% endif %} {% if rezervare.nivel_prioritate == 2 %}bg-secondary{% endif %} {% if rezervare.nivel_prioritate == 3 %}bg-primary{% endif %} {% if rezervare.nivel_prioritate == 4 %}bg-brown{% endif %} {% endif %}"
                data-nume="{{ rezervare.utilizator.last_name }} {{ rezervare.utilizator.first_name }}"
                data-email="{{ rezervare.utilizator.email }}"
                data-camera="{{ rezervare.utilizator.profilstudent.numar_camera }}"
                data-telefon="{{ rezervare.utilizator.profilstudent.telefon|default:'-' }}"
                style="cursor: pointer"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                title="{% if este_admin_camin or zi < today %}{{ rezervare.utilizator.get_full_name }}{% endif %}"
              >
                <div class="d-flex align-items-center w-100">
                  <span class="flex-grow-1"
                    >{{ ora }}:00 - {{ ora_sfarsit }}:00</span
                  >

                  {% if este_admin_camin and zi < today %}
                  <button
                    type="button"
                    class="btn-icon text-warning"
                    data-bs-toggle="modal"
                    data-bs-target="#confirmModal"
                    data-rezervare-id="{{ rezervare.id }}"
                    data-nume="{{ rezervare.utilizator.get_full_name }}"
                    data-data="{{ rezervare.data_rezervare|date:'d M Y' }}"
                    data-interval="{{ rezervare.ora_start|time:'H:i' }} - {{ rezervare.ora_end|time:'H:i' }}"
                    title="Trimite avertisment"
                  >
                    <i class="fas fa-exclamation-triangle"></i>
                  </button>
                  {% endif %} {% if not zi < today and
                  rezervare.nivel_prioritate != 1 %} {% if este_admin_camin or
                  este_student %}
                  <form
                    method="post"
                    action="{% url 'creeaza_rezervare' %}"
                    style="margin: 0"
                  >
                    {% csrf_token %}
                    <input
                      type="hidden"
                      name="masina_id"
                      value="{{ masina.id }}"
                    />
                    <input
                      type="hidden"
                      name="data"
                      value="{{ zi|date:'Y-m-d' }}"
                    />
                    <input
                      type="hidden"
                      name="ora_start"
                      value="{{ ora }}:00"
                    />
                    <input
                      type="hidden"
                      name="ora_end"
                      value="{{ ora_sfarsit }}:00"
                    />
                    <input
                      type="hidden"
                      name="saptamana"
                      value="{{ saptamana_index }}"
                    />
                    <button
                      type="submit"
                      class="btn-icon"
                      title="Preia rezervarea"
                    >
                      <i class="fas fa-exchange-alt"></i>
                    </button>
                  </form>
                  {% endif %} {% endif %}
                </div>
              </div>
            </div>
            {% else %} {% if este_admin_camin or este_student and zi >= today %}
            <div class="interval-container">
              <form
                method="post"
                action="{% url 'creeaza_rezervare' %}"
                class="h-100"
              >
                {% csrf_token %}
                <input type="hidden" name="masina_id" value="{{ masina.id }}" />
                <input
                  type="hidden"
                  name="data"
                  value="{{ zi|date:'Y-m-d' }}"
                />
                <input type="hidden" name="ora_start" value="{{ ora }}:00" />
                <input
                  type="hidden"
                  name="ora_end"
                  value="{{ ora_sfarsit }}:00"
                />
                <input
                  type="hidden"
                  name="saptamana"
                  value="{{ saptamana_index }}"
                />
                <button type="submit" class="btn-interval">
                  {{ ora }}:00 - {{ ora_sfarsit }}:00
                </button>
              </form>
            </div>
            {% else %}
            <div class="interval-container">
              <div class="time-slot text-muted">
                {{ ora }}:00 - {{ ora_sfarsit }}:00
              </div>
            </div>
            {% endif %} {% endif %} {% endwith %} {% endwith %} {% endfor %}
          </td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div
  class="modal fade"
  id="confirmModal"
  tabindex="-1"
  aria-labelledby="confirmModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="{% url 'adauga_avertisment_din_calendar' %}">
        {% csrf_token %}
        <input type="hidden" name="rezervare_id" id="rezervareIdInput" />
        <div class="modal-header">
          <h5 class="modal-title" id="confirmModalLabel">
            Confirmare Avertisment
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="√énchide"
          ></button>
        </div>
        <div class="modal-body">
          E»ôti sigur(ƒÉ) cƒÉ vrei sƒÉ trimi»õi un avertisment pentru
          <strong id="studentName"></strong>
          (rezervare: <span id="rezervareInfo"></span>)?
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Renun»õƒÉ
          </button>
          <button type="submit" class="btn btn-warning">
            Trimite Avertisment
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<div
  class="offcanvas offcanvas-end"
  data-bs-backdrop="false"
  tabindex="-1"
  id="detaliiStudent"
  aria-labelledby="detaliiStudentLabel"
>
  <div class="offcanvas-header">
    <h5 id="detaliiStudentLabel">Detalii Student</h5>
    <button
      type="button"
      class="btn-close"
      data-bs-dismiss="offcanvas"
      aria-label="√énchide"
    ></button>
  </div>
  <div class="offcanvas-body">
    <p><strong>Nume:</strong> <span id="studentNume"></span></p>
    <p><strong>Email:</strong> <span id="studentEmail"></span></p>
    <p><strong>Telefon:</strong> <span id="studentTelefon"></span></p>
    <p><strong>CamerƒÉ:</strong> <span id="studentCamera"></span></p>
  </div>
</div>

{% if messages %}
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
  {% for message in messages %}
  <div class="toast border-0 show" role="alert">
    <div class="d-flex">
      <div class="toast-body bg-{{ message.tags }}">{{ message }}</div>
      <button
        type="button"
        class="btn-close me-2 m-auto"
        data-bs-dismiss="toast"
      ></button>
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}

<script>
  document.addEventListener("DOMContentLoaded", function () {
    var tooltipTriggerList = [].slice.call(
      document.querySelectorAll('[data-bs-toggle="tooltip"]')
    );
    tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    var modal = document.getElementById("confirmModal");
    if (modal) {
      modal.addEventListener("show.bs.modal", function (event) {
        var button = event.relatedTarget;
        document.getElementById("rezervareIdInput").value =
          button.getAttribute("data-rezervare-id");
        document.getElementById("studentName").textContent =
          button.getAttribute("data-nume") || "student necunoscut";
        document.getElementById("rezervareInfo").textContent =
          button.getAttribute("data-data") &&
          button.getAttribute("data-interval")
            ? button.getAttribute("data-data") +
              " " +
              button.getAttribute("data-interval")
            : "necunoscut";
      });
    }

    document.querySelectorAll(".rezervare").forEach((el) => {
      el.addEventListener("click", (e) => {
        if (e.target.closest("button")) return;
        document.getElementById("studentNume").textContent =
          el.dataset.nume || "-";
        document.getElementById("studentEmail").textContent =
          el.dataset.email || "-";
        document.getElementById("studentTelefon").textContent =
          el.dataset.telefon || "-";
        document.getElementById("studentCamera").textContent =
          el.dataset.camera || "-";
        new bootstrap.Offcanvas(
          document.getElementById("detaliiStudent")
        ).show();
      });
    });
  });
</script>
{% endblock %}
