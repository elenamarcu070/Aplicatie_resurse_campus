{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<div class="container mt-4 fade-in" style="max-width: 1200px;">
  <div class="py-3 px-4 mb-4 rounded shadow text-black" style="background-color:rgb(255, 255, 255);">
    <h2 class="mb-3 text-center fw-bold" style="font-size: 1.8rem;">
      Rezervari Spalatorie – 
      camin {{ nume_camin|default:"Cămin necunoscut" }} 
      ({{ start_saptamana|date:"d M" }} – {{ end_saptamana|date:"d M" }})
    </h2>

    <div class="d-flex justify-content-between">
      <a href="?saptamana={{ saptamana_precedenta }}" class="btn btn-light px-4 py-2 fw-semibold">
        ← Săptămâna trecută
      </a>
      <a href="?saptamana={{ saptamana_urmatoare }}" class="btn btn-light px-4 py-2 fw-semibold">
        Săptămâna viitoare →
      </a>
    </div>
  </div>

  <table class="table table-bordered text-center align-middle">
    <thead>
      <tr>
        <th>Mașină</th>
        {% for zi in zile_saptamana %}
          <th>{{ zi|date:"D, d M" }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for masina in masini %}
        <tr>
          <th class="bg-light">{{ masina.nume }}</th>
          {% for zi in zile_saptamana %}
            <td>
              {% for ora in intervale_ore %}
                {% with ora_sfarsit=ora|add:"2" %}
                {% with rezervare=rezervari_dict|get_item:masina.id|get_item:zi|get_item:ora %}
                  {% if rezervare %}
                    <div class="mb-1">
                      {% if zi < today %}
                        <span class="badge w-100 text-white bg-warning">
                          {{ ora }}:00 - {{ ora_sfarsit }}:00
                          {% if este_admin_camin and not rezervare.avertizat %}
                            <button class="btn btn-sm btn-link p-0 ms-1 text-dark" title="Trimite avertisment"
                                    data-bs-toggle="modal" data-bs-target="#confirmModal"
                                    data-rezervare-id="{{ rezervare.id }}">
                              ⚠️
                            </button>
                          {% endif %}
                        </span>
                      {% else %}
                        {% if rezervare.prioritara %}
                          <span class="badge w-100 text-white bg-danger">
                            {{ ora }}:00 - {{ ora_sfarsit }}:00
                          </span>
                        {% else %}
                          <span class="badge w-100 text-white bg-secondary" title="Această rezervare poate fi înlocuită de un student cu prioritate">
                            {{ ora }}:00 - {{ ora_sfarsit }}:00 ❕
                          </span>
                        {% endif %}
                      {% endif %}
                    </div>
                  {% else %}
                    {% if este_admin_camin or este_student %}
                      <form method="post" action="{% url 'creeaza_rezervare' %}" class="mb-1">
                        {% csrf_token %}
                        <input type="hidden" name="masina_id" value="{{ masina.id }}">
                        <input type="hidden" name="data" value="{{ zi|date:'Y-m-d' }}">
                        <input type="hidden" name="ora_start" value="{{ ora }}:00">
                        <input type="hidden" name="ora_end" value="{{ ora_sfarsit }}:00">
                        <button type="submit" class="btn btn-outline-success btn-sm w-100">
                          {{ ora }}:00 - {{ ora_sfarsit }}:00
                        </button>
                      </form>
                    {% else %}
                      <div class="mb-1 text-muted">{{ ora }}:00 - {{ ora_sfarsit }}:00</div>
                    {% endif %}
                  {% endif %}
                {% endwith %}
                {% endwith %}
              {% endfor %}
            </td>
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Modal confirmare avertisment -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="{% url 'adauga_avertisment_din_calendar' %}">
        {% csrf_token %}
        <input type="hidden" name="rezervare_id" id="rezervareIdInput">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmModalLabel">Confirmare Avertisment</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Închide"></button>
        </div>
        <div class="modal-body">
          Ești sigură că vrei să trimiți un avertisment pentru această rezervare?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Renunță</button>
          <button type="submit" class="btn btn-warning">Trimite Avertisment</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% if messages %}
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    {% for message in messages %}
      <div class="toast align-items-center text-white bg-success border-0 show" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">
            {{ message }}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Închide"></button>
        </div>
      </div>
    {% endfor %}
  </div>
{% endif %}

<script>
  document.addEventListener('DOMContentLoaded', function () {
    var modal = document.getElementById('confirmModal');
    modal.addEventListener('show.bs.modal', function (event) {
      var button = event.relatedTarget;
      var rezervareId = button.getAttribute('data-rezervare-id');
      var input = document.getElementById('rezervareIdInput');
      input.value = rezervareId;
    });
  });
</script>
{% endblock %}
