{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<style>
    .interval-container {
        height: 34px;
        margin-bottom: 4px;
        min-width: 150px;
        width: 100%;
    }
    .table td {
        padding: 5px;
        vertical-align: middle;
        min-width: 160px;
        width: 160px;
    }
    .table th:first-child {
        min-width: 100px;
        width: 100px;
    }
    .table-responsive {
        overflow-x: auto;
    }
    .time-slot {
        font-size: 0.9em;
        padding: 5px 8px;
        height: 100%;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        white-space: nowrap;
    }
    .btn-interval {
        width: 100%;
        height: 100%;
        min-width: 150px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #28a745;
        color: #28a745;
        background-color: transparent;
        border-radius: 4px;
        transition: all 0.2s ease;
    }
    .btn-interval:hover { background-color: #28a745; color: white; }
    .rezervare {
        height: 100%;
        width: 100%;
        padding: 5px 8px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        transition: all 0.3s ease;
        white-space: nowrap;
    }
    .bg-danger { background-color: #dc3545 !important; color: white !important; }
    .bg-secondary { background-color: #6c757d !important; color: white !important; }
    .bg-primary { background-color: #0d6efd !important; color: white !important; }
    .bg-brown { background-color: #D2B48C !important; color: white !important; }
    .bg-warning { background-color: #ffc107 !important; color: black !important; }
    .bg-blocked { background-color: #adb5bd !important; color: white !important; border-radius: 4px; }

    .btn-icon {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.8);
        padding: 0;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .btn-icon:hover { color: white; transform: scale(1.1); }
    .btn-icon i { font-size: 0.8rem; }

    .container { max-width: 1200px; }
    .shadow { box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15) !important; }

    .badge { width: 20px; height: 20px; display: inline-flex; align-items: center; justify-content: center; }
    .legend-item { display: flex; align-items: center; margin: 0.5rem; }
    .legend-text { margin-left: 0.5rem; font-size: 0.875rem; color: #666; }

    .toast { opacity: 1 !important; background-color: white !important; }
    .toast .toast-body { color: black !important; font-weight: 500; }

    .tooltip { font-size: 0.8rem; }
</style>

<div class="container mt-4 fade-in">
    <div class="py-3 px-4 mb-4 rounded shadow text-black" style="background-color:white;">
        <h2 class="mb-3 text-center fw-bold" style="font-size:1.8rem;">
            Rezervări Spălătorie – {{ nume_camin|default:"Cămin necunoscut" }}
            ({{ start_saptamana|date:"d M" }} – {{ end_saptamana|date:"d M" }})
        </h2>

        <div class="mb-4">
            <div class="d-flex justify-content-center flex-wrap">
                <div class="legend-item"><span class="badge bg-danger">■</span><span class="legend-text">Prima rezervare</span></div>
                <div class="legend-item"><span class="badge bg-secondary">■</span><span class="legend-text">A doua rezervare</span></div>
                <div class="legend-item"><span class="badge bg-primary">■</span><span class="legend-text">A treia rezervare</span></div>
                <div class="legend-item"><span class="badge bg-brown">■</span><span class="legend-text">A patra rezervare</span></div>
                <div class="legend-item"><span class="badge bg-warning">■</span><span class="legend-text">Rezervare trecută</span></div>
                <div class="legend-item"><span class="badge bg-blocked">■</span><span class="legend-text">Interval dezactivat</span></div>
                <div class="legend-item"><span class="badge bg-success">■</span><span class="legend-text">Slot disponibil</span></div>
            </div>
        </div>

        <div class="d-flex justify-content-between">
            <a href="?saptamana={{ saptamana_precedenta }}" class="btn btn-light px-4 py-2 fw-semibold">← Săptămâna trecută</a>
            <a href="?saptamana={{ saptamana_urmatoare }}" class="btn btn-light px-4 py-2 fw-semibold">Săptămâna viitoare →</a>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered text-center align-middle">
            <thead>
                <tr>
                    <th>Mașină</th>
                    {% for zi in zile_saptamana %}
                        <th>{{ zi|date:"D, d M" }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for masina in masini %}
                    <tr>
                        <th class="bg-light">{{ masina.nume }}</th>
                        {% for zi in zile_saptamana %}
                            <td>
                                {% for ora in intervale_ore %}
                                    {% with ora_sfarsit=ora|add:"2" %}
                                        {% with rezervare=rezervari_dict|get_item:masina.id|get_item:zi|get_item:ora %}
                                            {% if rezervare %}
                                                <div class="interval-container">
                                                    <div class="rezervare 
                                                        {% if zi < today %}bg-warning{% else %}
                                                            {% if rezervare.nivel_prioritate == 1 %}bg-danger{% endif %}
                                                            {% if rezervare.nivel_prioritate == 2 %}bg-secondary{% endif %}
                                                            {% if rezervare.nivel_prioritate == 3 %}bg-primary{% endif %}
                                                            {% if rezervare.nivel_prioritate == 4 %}bg-brown{% endif %}
                                                        {% endif %}"
                                                        data-nume="{{ rezervare.utilizator.last_name }} {{ rezervare.utilizator.first_name }}"
                                                        data-email="{{ rezervare.utilizator.email }}"
                                                        data-camera="{{ rezervare.utilizator.profilstudent.numar_camera }}"
                                                        data-telefon="{{ rezervare.utilizator.profilstudent.telefon|default:'-' }}"
                                                        style="cursor:pointer;"
                                                        data-bs-toggle="tooltip" 
                                                        title="{{ rezervare.utilizator.get_full_name }}">
                                                        <div class="d-flex align-items-center w-100">
                                                            <span class="flex-grow-1">{{ ora }}:00 - {{ ora_sfarsit }}:00</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% else %}
                                                {% with este_blocat=False %}
                                                    {% for blocaj in intervale_blocate %}
                                                        {% if blocaj.masina.id == masina.id and blocaj.data == zi and ora < blocaj.ora_end.hour and ora|add:"2" > blocaj.ora_start.hour %}
                                                            {% with este_blocat=True %}
                                                            {% endwith %}
                                                        {% endif %}
                                                    {% endfor %}
                                                    {% if este_blocat %}
                                                        <div class="interval-container">
                                                            <div class="time-slot bg-blocked">Dezactivat</div>
                                                        </div>
                                                    {% elif este_admin_camin or este_student and zi >= today %}
                                                        <div class="interval-container">
                                                            <form method="post" action="{% url 'creeaza_rezervare' %}" class="h-100">
                                                                {% csrf_token %}
                                                                <input type="hidden" name="masina_id" value="{{ masina.id }}">
                                                                <input type="hidden" name="data" value="{{ zi|date:'Y-m-d' }}">
                                                                <input type="hidden" name="ora_start" value="{{ ora }}:00">
                                                                <input type="hidden" name="ora_end" value="{{ ora_sfarsit }}:00">
                                                                <input type="hidden" name="saptamana" value="{{ saptamana_index }}">
                                                                <button type="submit" class="btn-interval">{{ ora }}:00 - {{ ora_sfarsit }}:00</button>
                                                            </form>
                                                        </div>
                                                    {% else %}
                                                        <div class="interval-container">
                                                            <div class="time-slot text-muted">{{ ora }}:00 - {{ ora_sfarsit }}:00</div>
                                                        </div>
                                                    {% endif %}
                                                {% endwith %}
                                            {% endif %}
                                        {% endwith %}
                                    {% endwith %}
                                {% endfor %}
                            </td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% if messages %}
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    {% for message in messages %}
        <div class="toast border-0 show" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body bg-{{ message.tags }}">{{ message }}</div>
                <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Închide"></button>
            </div>
        </div>
    {% endfor %}
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function () {
    [...document.querySelectorAll('[data-bs-toggle="tooltip"]')].forEach(el => new bootstrap.Tooltip(el));
    [...document.querySelectorAll('.toast')].forEach(el => new bootstrap.Toast(el, {autohide: true, delay: 3000}).show());
});
</script>
{% endblock %}
