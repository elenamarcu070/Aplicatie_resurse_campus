{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<style>
    .interval-container { height: 34px; margin-bottom: 4px; min-width: 150px; width: 100%; }
    .table td { padding: 5px; vertical-align: middle; width: calc(100% / 8); white-space: nowrap; }
    .table th:first-child { width: 12%; min-width: 100px; }
    .calendar-grid thead th {
        position: sticky; top: 0; background: white; z-index: 3;
        box-shadow: 0 2px 0 #e9edf2;
    }
    .calendar-grid th.bg-light { position: sticky; left: 0; background: white !important; z-index: 2; box-shadow: 2px 0 0 #e9edf2; }
    .calendar-grid tbody td:nth-child(odd) { background: #fbfdff; }

    .time-slot { padding: 5px 8px; display: flex; align-items: center; justify-content: center; }
    .btn-interval { width: 100%; border: 1px solid #28a745; color: #28a745; background: transparent; border-radius: 4px; }
    .btn-interval:hover { background: #28a745; color: white; }

    .rezervare { width: 100%; padding: 5px 8px; border-radius: 4px; display: flex; align-items: center; }

    .bg-danger{ background-color:#dc3545!important;color:#fff!important; }
    .bg-secondary{ background-color:#6c757d!important;color:#fff!important; }
    .bg-primary{ background-color:#0d6efd!important;color:#fff!important; }
    .bg-brown{ background-color:#D2B48C!important;color:#fff!important; }
    .bg-warning{ background-color:#ffc107!important;color:#000!important; }
    .bg-own{ background-color:#b3e5fc!important;color:#01579b!important; }

    .btn-icon{ background:none;border:none;color:white; width:20px;height:20px; cursor:pointer; }
    .btn-icon i { font-size:.8rem; }
</style>

<div class="container mt-4 fade-in">

    <div class="py-3 px-4 mb-4 rounded shadow bg-white text-black">
        <h2 class="mb-3 text-center fw-bold" style="font-size:1.8rem;">
            Rezervari Spalatorie – camin {{ nume_camin }}
            ({{ start_saptamana|date:"d M" }} – {{ end_saptamana|date:"d M" }})
        </h2>

        <div class="d-flex justify-content-center flex-wrap">
            <div class="legend-item"><span class="badge bg-danger">■</span>&nbsp;Prima rezervare</div>
            <div class="legend-item"><span class="badge bg-secondary">■</span>&nbsp;A doua rezervare</div>
            <div class="legend-item"><span class="badge bg-primary">■</span>&nbsp;A treia rezervare</div>
            <div class="legend-item"><span class="badge bg-brown">■</span>&nbsp;A patra rezervare</div>
            <div class="legend-item"><span class="badge bg-warning">■</span>&nbsp;Rezervare trecută</div>
            <div class="legend-item"><span class="badge bg-success">■</span>&nbsp;Slot disponibil</div>
            <div class="legend-item"><span class="badge bg-own">■</span>&nbsp;Rezervările mele</div>
        </div>

        <div class="d-flex justify-content-between mt-3">
            <a href="?saptamana={{ saptamana_precedenta }}" class="btn btn-light px-4 py-2 fw-semibold">← Săptămâna trecută</a>
            <a href="?saptamana={{ saptamana_urmatoare }}" class="btn btn-light px-4 py-2 fw-semibold">Săptămâna viitoare →</a>
        </div>
    </div>

    {% if not are_telefon %}
    <div class="alert alert-danger shadow-sm d-flex justify-content-between align-items-center">
        <span>Adaugă numărul tău de telefon pentru notificări WhatsApp!</span>
        <a href="{% url 'dashboard_student' %}" class="btn btn-light btn-sm">Adaugă număr</a>
    </div>
    {% endif %}

    <div class="table-responsive">
        <table class="table table-bordered text-center align-middle calendar-grid">
            <thead>
                <tr>
                    <th>Mașină</th>
                    {% for zi in zile_saptamana %}
                        <th>{{ zi|date:"D, d M" }}</th>
                    {% endfor %}
                </tr>
            </thead>

            <tbody>
            {% for masina in masini %}
                <tr>
                    <th class="bg-light">{{ masina.nume }}</th>

                    {% for zi in zile_saptamana %}
                    <td>
                        {% for interval in intervale_ore %}
                            {% with ora_start=interval.0 ora_sfarsit=interval.1 %}
                            {% with rezervare=rezervari_dict|get_item:masina.id|get_item:zi|get_item:ora_start %}

                                {% if rezervare %}
                                <!-- ================== SLOT REZERVAT ================== -->
                                <div class="interval-container">
                                    <div class="rezervare
                                        {% if zi < today %}
                                            bg-warning
                                        {% else %}
                                            {% if zi == today %}
                                                {% if ora_sfarsit <= now_hour %}
                                                    bg-warning
                                                {% else %}
                                                    {% if rezervare.utilizator == request.user %}
                                                        bg-own
                                                    {% else %}
                                                        {% if rezervare.nivel_prioritate == 1 %}bg-danger{% endif %}
                                                        {% if rezervare.nivel_prioritate == 2 %}bg-secondary{% endif %}
                                                        {% if rezervare.nivel_prioritate == 3 %}bg-primary{% endif %}
                                                        {% if rezervare.nivel_prioritate == 4 %}bg-brown{% endif %}
                                                    {% endif %}
                                                {% endif %}
                                            {% else %}
                                                {% if rezervare.utilizator == request.user %}
                                                    bg-own
                                                {% else %}
                                                    {% if rezervare.nivel_prioritate == 1 %}bg-danger{% endif %}
                                                    {% if rezervare.nivel_prioritate == 2 %}bg-secondary{% endif %}
                                                    {% if rezervare.nivel_prioritate == 3 %}bg-primary{% endif %}
                                                    {% if rezervare.nivel_prioritate == 4 %}bg-brown{% endif %}
                                                {% endif %}
                                            {% endif %}
                                        {% endif %}"
                                        data-nume="{{ rezervare.utilizator.get_full_name }}"
                                        data-email="{{ rezervare.utilizator.email }}"
                                        data-camera="{{ rezervare.utilizator.profilstudent.numar_camera|default:'-' }}"
                                        data-telefon="{{ rezervare.utilizator.profilstudent.telefon|default:'-' }}"
                                        style="cursor:pointer;"
                                    >
                                        <div class="d-flex align-items-center w-100">
                                            <span class="flex-grow-1">{{ ora_start }}:00 - {{ ora_sfarsit }}:00</span>

                                            {% if este_admin_camin %}
                                                {% if zi < today or zi == today and ora_sfarsit <= now_hour %}
                                                <button type="button" class="btn-icon text-warning"
                                                    data-bs-toggle="modal" data-bs-target="#confirmModal"
                                                    data-rezervare-id="{{ rezervare.id }}"
                                                    data-nume="{{ rezervare.utilizator.get_full_name }}"
                                                    data-data="{{ rezervare.data_rezervare|date:'d M Y' }}"
                                                    data-interval="{{ rezervare.ora_start|time:'H:i' }} - {{ rezervare.ora_end|time:'H:i' }}">
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                </button>
                                                {% endif %}
                                            {% endif %}

                                            {% if rezervare.nivel_prioritate != 1 %}
                                                {% if zi > today or zi == today and ora_sfarsit > now_hour %}
                                                    {% if este_admin_camin or este_student %}
                                                    <form method="post" action="{% url 'creeaza_rezervare' %}" style="margin:0;">
                                                        {% csrf_token %}
                                                        <input type="hidden" name="masina_id" value="{{ masina.id }}">
                                                        <input type="hidden" name="data" value="{{ zi|date:'Y-m-d' }}">
                                                        <input type="hidden" name="ora_start" value="{{ ora_start }}:00">
                                                        <input type="hidden" name="ora_end" value="{{ ora_sfarsit }}:00">
                                                        <input type="hidden" name="saptamana" value="{{ saptamana_index }}">
                                                        <button class="btn-icon"><i class="fas fa-exchange-alt"></i></button>
                                                    </form>
                                                    {% endif %}
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                {% else %}
                                <!-- ================== SLOT LIBER ================== -->
                                    {% if zi > today %}
                                        {% include "dashboard/student/_slot_verde.html" %}
                                    {% elif zi == today %}
                                        {% if ora_sfarsit > now_hour %}
                                            {% include "dashboard/student/_slot_verde.html" %}
                                        {% else %}
                                            <div class="interval-container">
                                                <div class="time-slot text-muted">{{ ora_start }}:00 - {{ ora_sfarsit }}:00</div>
                                            </div>
                                        {% endif %}
                                    {% else %}
                                        <div class="interval-container">
                                            <div class="time-slot text-muted">{{ ora_start }}:00 - {{ ora_sfarsit }}:00</div>
                                        </div>
                                    {% endif %}
                                {% endif %}

                            {% endwith %}
                            {% endwith %}
                        {% endfor %}
                    </td>
                    {% endfor %}

                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

</div>


<!-- Modal avertisment -->
<div class="modal fade" id="confirmModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="{% url 'adauga_avertisment_din_calendar' %}">
        {% csrf_token %}
        <input type="hidden" name="rezervare_id" id="rezervareIdInput">
        <div class="modal-header">
            <h5 class="modal-title">Confirmare Avertisment</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            Ești sigur(ă) că vrei să trimiți un avertisment pentru
            <strong id="studentName"></strong>
            (rezervare: <span id="rezervareInfo"></span>)?
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Renunță</button>
            <button class="btn btn-warning">Trimite Avertisment</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Offcanvas -->
<div class="offcanvas offcanvas-end" id="detaliiStudent">
  <div class="offcanvas-header">
    <h5>Detalii Student</h5>
    <button class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <p><strong>Nume:</strong> <span id="studentNume"></span></p>
    <p><strong>Email:</strong> <span id="studentEmail"></span></p>
    <p><strong>Telefon:</strong> <span id="studentTelefon"></span></p>
    <p><strong>Cameră:</strong> <span id="studentCamera"></span></p>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {

  // tooltip-uri
  document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(function(el){
    new bootstrap.Tooltip(el);
  });

  // modal avertisment
  const modal = document.getElementById('confirmModal');
  if (modal) {
    modal.addEventListener('show.bs.modal', function(event){
      const btn = event.relatedTarget;
      document.getElementById('rezervareIdInput').value = btn.dataset.rezervareId;
      document.getElementById('studentName').textContent = btn.dataset.nume;
      document.getElementById('rezervareInfo').textContent = btn.dataset.data + " " + btn.dataset.interval;
    });
  }

  // offcanvas detalii student
  document.querySelectorAll('.rezervare').forEach(el=>{
    el.addEventListener('click', e=>{
      if (!e.target.closest("button")) {
        document.getElementById("studentNume").textContent = el.dataset.nume;
        document.getElementById("studentEmail").textContent = el.dataset.email;
        document.getElementById("studentTelefon").textContent = el.dataset.telefon;
        document.getElementById("studentCamera").textContent = el.dataset.camera;
        new bootstrap.Offcanvas(document.getElementById("detaliiStudent")).show();
      }
    });
  });

});
</script>

{% endblock %}
