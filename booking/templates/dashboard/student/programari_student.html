{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4 fade-in" style="max-width: 900px;">
  <div class="card p-4 mb-4" style="background-color: rgba(255, 255, 255, 0.95); border-radius: 16px;">
    <h3 class="text-center mb-4">Programările Tale</h3>

    <ul class="nav nav-tabs" id="myTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="urmatoare-tab" data-bs-toggle="tab" data-bs-target="#urmatoare" type="button" role="tab" aria-controls="urmatoare" aria-selected="true">Următoare</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="incheiate-tab" data-bs-toggle="tab" data-bs-target="#incheiate" type="button" role="tab" aria-controls="incheiate" aria-selected="false">Încheiate</button>
      </li>
    </ul>

    <div class="tab-content mt-3" id="myTabContent">
      <!-- Următoare -->
      <div class="tab-pane fade show active" id="urmatoare" role="tabpanel" aria-labelledby="urmatoare-tab">
        {% if rezervari_urmatoare %}
          <div class="list-group">
            {% for r in rezervari_urmatoare %}
              <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-start" id="rezervare-{{ r.id }}">
                <div class="ms-2 me-auto">
                  <div class="fw-bold">{{ r.masina.nume }} - {{ r.data_rezervare|date:"j F Y" }}</div>
                  {{ r.ora_start|time:"H:i" }} - {{ r.ora_end|time:"H:i" }}
                </div>
                <button
                  class="btn btn-sm btn-danger anuleaza-rezervare"
                  data-rezervare-id="{{ r.id }}"
                  data-url="{% url 'anuleaza_rezervare' r.id %}"
                  type="button">
                  Anulează
                </button>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted">Nu ai programări viitoare.</p>
        {% endif %}
      </div>

      <!-- Încheiate -->
      <div class="tab-pane fade" id="incheiate" role="tabpanel" aria-labelledby="incheiate-tab">
        {% if rezervari_incheiate %}
          <div class="list-group">
            {% for r in rezervari_incheiate %}
              <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-start">
                <div class="ms-2 me-auto">
                  <div class="fw-bold">{{ r.masina.nume }} - {{ r.data_rezervare|date:"j F Y" }}</div>
                  {{ r.ora_start|time:"H:i" }} - {{ r.ora_end|time:"H:i" }}
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted">Nu ai programări încheiate în ultimele 7 zile.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const buttons = document.querySelectorAll('.anuleaza-rezervare');

  function getCSRF() {
    const name = 'csrftoken=';
    const parts = document.cookie.split(';');
    for (let c of parts) {
      c = c.trim();
      if (c.startsWith(name)) return decodeURIComponent(c.slice(name.length));
    }
    return null;
  }

  buttons.forEach(btn => {
    btn.addEventListener('click', async function (e) {
      e.preventDefault();

      const rowId = this.dataset.rezervareId;
      const url   = this.dataset.url; // URL corect generat de Django
      const csrftoken = getCSRF();
      if (!csrftoken) { alert('Lipsește CSRF token.'); return; }

      try {
        const resp = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({})
        });

        const data = await resp.json().catch(() => ({}));

        if (resp.ok && data.success) {
          const row = document.getElementById(`rezervare-${rowId}`);
          if (row) row.remove();
          alert('Rezervarea a fost anulată cu succes!');
        } else {
          const msg = (data && data.error) ? data.error : `Eroare ${resp.status}`;
          alert('Eroare la anulare: ' + msg);
        }
      } catch (err) {
        console.error('Eroare la anularea rezervării:', err);
        alert('A apărut o eroare la anularea rezervării. Verificați consola.');
      }
    });
  });
});
</script>
{% endblock %}
